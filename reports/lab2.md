## lab2实验报告

#### 第一部分 实验结果

![img](file:///C:\Users\Hp\AppData\Local\Temp\QQ_1723602146223.png)

代码思路：首先在task的mod中创建接口供系统调用使用，之后task的接口会调用对应任务的MemorySet，主要的工作也是在MS之中完成的。mmap新建了一个Maparea放入MS当中，并且进行映射，start_vpn和end_vpn均采用floor()，因为这样可以保证_start按页对齐的情况在加上4096也正好还在一个页面。这里如果用一个floor()，一个ceil()会导致分到两个页面上。unmap则是将上述操作从map换成unmap，不同在于插入的时候会新建一个area，但是删除的时候不知道area是哪一个，所以需要遍历，如果找到了就进行删除并返回-1，如果找不到就返回-1。

task_info和get_time主要是在Page_Tables下面新建了一个可以根据偏移量和页号返回对应开头的变量，原来的函数只能是页的开头，不是很好用



#### 第二部分 问答题

1.实验手册中已经提及

![../_images/sv39-pte.png](https://learningos.cn/rCore-Tutorial-Guide-2024S/_images/sv39-pte.png)

- 仅当 V(Valid) 位为 1 时，页表项才是合法的；
- R/W/X 分别控制索引到这个页表项的对应虚拟页面是否允许读/写/取指；
- U 控制索引到这个页表项的对应虚拟页面是否在 CPU 处于 U 特权级的情况下是否被允许访问；
- G 我们不理会；
- A(Accessed) 记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过；
- D(Dirty) 则记录自从页表项上的这一位被清零之后，页表项的对应虚拟页表是否被修改过。

2.（1）缺页导致的异常，经过上网查询，得到以下几种异常（可能仍然不够全面）:内存分配异常，因为有的内存实际上已经被分配，但是缺页导致MS不知道；磁盘IO错误，缺页后计算机不知道去哪个物理地址读取数据；权限安全异常，因为缺页可能触发操作系统或者硬件的一些保护程序；死锁，缺页可能导致不同资源之间的内存管理出现问题

（2）

- **程序状态字寄存器（Program Status Word, PSW）或标志寄存器（Flags Register）**：
  - 包含处理器的状态信息，如中断使能、条件码等。
- **页故障线性地址（Page Fault Linear Address, PFLA）或故障地址寄存器（Fault Address Register, FAR）**：
  - 保存发生缺页的虚拟地址。
- **页故障错误代码（Page Fault Error Code, PFEC）**：
  - 提供缺页异常的额外信息，如访问类型（读/写），是否在用户模式下发生等。
- **页表入口（Page Table Entry, PTE）**：
  - 可能需要检查以确定缺页的原因，比如页面是否存在或权限设置。
- **控制寄存器（Control Registers）**：
  - 在某些架构中，控制寄存器用于管理分页和异常处理。
- **任务寄存器（Task Register）**：
  - 在某些操作系统中，任务寄存器指向当前进程的任务状态段。
- **段寄存器（Segment Registers）**：
  - 保存当前活动的段的信息，可能与缺页异常有关。

（3）显然能够减少系统的开销，即如果这个程序没有被开启进程的话，就不需要浪费时间进行IO，此外也可以减少磁盘空间的使用，申请了很多空间，如果不开启对应进程的话就不会使用，这样会导致浪费空间。综上，好处就是节省时间和空间。

（4）SV39页表需要以4kb为单位进行页的划分，一个页表包含512个页表项，所以一个页表可以存储2MB的虚拟空间，由10GB可得，一共需要5120个页表，一个页表占据8个字节，所以大概需要40MB的内存来存储这些页表，这些还没有考虑多级页表，如果引入多级页表那么显然要占据更多的内存空间

（5）先存储下来用户申请的内存空间对应的虚拟地址构成的逻辑段，然后存储到磁盘上面，之后如果用户访问某个虚拟页面，则去该文件上查询，如果查到了，那么就将整个逻辑段都加载到内存中，如果没有查到，那么只加载该虚拟地址即可

（6）页面的失效可能表现在PTE中的有效位，由于用户态的程序是不能直接访问磁盘的，所以此时的页面的有效位被修改为0，而交换回来后如果没有及时调整就会导致缺页发生

3.（1）可以使用基址寄存器切换，将两种页表分开放置

（2）PTE的U访问权限位

（3）节省了时间和空间，不需要切换页表进行虚拟内存的映射，页表的物理内存地址也更加紧凑，符合程序的局部性

（4）切换APP和OS的时候就需要更换页表。我会在APP和OS切换的时候以及进程发生变化的情况时更新页表，即调整基址寄存器
